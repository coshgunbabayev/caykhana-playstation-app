<div class="container mt-4">
    <div class="row bg-light py-2 rounded border">
        <div class="col-10">
            <input type="text" id="searchInput" class="form-control" placeholder="Məhsul axtar"
                oninput="searchProduct()">
        </div>
        <div class="col-2 d-flex align-items-center">
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addProductModal">
                Məhsul əlavə et</button>
        </div>
    </div>

    <div class="row bg-primary text-white fw-bold py-2 rounded mt-2">
        <div class="col-4">Məhsulun adı</div>
        <div class="col-2">Say</div>
        <div class="col-2">Alış qiyməti</div>
        <div class="col-2">Satış qiyməti</div>
        <div class="col-2 text-center">Ayarlar</div>
    </div>

    <div id="productList"> </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Yeni məhsul</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <form id="addProductForm">
                    <div class="row gy-2 overflow-hidden">

                        <div class="col-12">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" name="name" id="name" placeholder="Ad">
                                <label for="name" class="form-label">Ad</label>
                                <div class="fs-6 invalid-feedback" id="nameError"></div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" name="sale" id="sale" placeholder="Ad">
                                <label for="sale" class="form-label">Qiymət</label>
                                <div class="fs-6 invalid-feedback" id="saleError"></div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="d-grid my-3">
                                <button class="btn btn-primary btn-lg" type="submit">Əlavə et</button>
                            </div>
                        </div>

                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    const productListDiv = document.getElementById('productList');
    const addProductForm = document.getElementById('addProductForm');

    function displayProducts(productList) {
        productListDiv.innerHTML = '';
        productList.forEach(product => {
            productListDiv.innerHTML += `
          <div class="row bg-light py-2 rounded border mt-2">
            <div class="col-4">${product.name}</div>
            <div class="col-2">${product.quatity}</div>
            <div class="col-2">${product.purchase}</div>
            <div class="col-2">${product.sale}</div>
            <div class="col-2 text-center">
                <button class="btn btn-warning btn-sm mx-1" onclick="editProduct('${product.id}')">Düzenle</button>
                <button class="btn btn-danger btn-sm mx-1" onclick="deleteProduct('${product.id}')">Sil</button>
            </div>
          </div>
        `;
        });
    };

    async function getProducts() {
        let res = await fetch('/api/admin/warehouse', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (res.ok) {
            res = await res.json();
            return res.products;
        } else {
            return [];
        };
    };

    let products = [];
    document.addEventListener("DOMContentLoaded", async function () {
        products = await getProducts();
        displayProducts(products);
    });

    function searchProduct() {
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();
        const filteredProducts = products.filter(product =>
            product.name.toLowerCase().includes(searchQuery)
        );
        displayProducts(filteredProducts);
    };

    addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(addProductForm);

        try {
            let res = await fetch('/api/admin/warehouse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: formData.get('name'),
                    sale: formData.get('sale')
                })
            });

            if (res.ok) {
                document.location.reload();
            } else {
                res = await res.json();
                alert(res);
            };
        } catch (err) {
            console.error('err:::', error);
        };
    });

    function editProduct(id) {
    }

    async function deleteProduct(id) {
        if (!confirm('Məhsul silinsin?')) {
            return;
        };

        let res = await fetch(`/api/admin/warehouse/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (res.ok) {
            document.location.reload();
        } else {
            res = await res.json();

            alert(res);
        };
    };
</script>